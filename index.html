<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống thi Tiếng Việt Cấp Tỉnh</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        window.FirebaseSDK = { initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, signOut, getFirestore, collection, addDoc, query, onSnapshot, doc, setDoc, getDoc };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // DANH SÁCH 10 MÃ ĐỊNH DANH GẮN LIỀN VỚI TÊN HỌC SINH
        const STUDENT_DATABASE = {
            'VC-9921': 'Phạm Văn Chiến',
            'VC-1123': 'Phạm Văn Chiến',
            'VC-4452': 'Phạm Văn Chiến',
            'TH-8871': 'Phạm Nguyễn Thảo Huyền',
            'TH-3304': 'Phạm Nguyễn Thảo Huyền',
            'DK-2219': 'Đoàn Đăng Khoa',
            'DK-5567': 'Đoàn Đăng Khoa',
            'KM-7781': 'Đặng Thị Kim Mai',
            'KM-1190': 'Đặng Thị Kim Mai',
            'KM-6643': 'Đặng Thị Kim Mai'
        };

        const ALL_QUESTIONS = [
            { id: 1, type: 'fill', text: '“Hai ……a con bước đi trên cát\nÁnh mặt ……ời rực rỡ biển xanh\nBóng ……a dài lênh khênh\nBóng con ……òn ……ắc nịch.”\n(Hoàng Trung Thông)', instruction: 'Điền “ch” hoặc “tr” vào chỗ trống', answers: ['ch', 'tr', 'ch', 'tr', 'ch'], placeholders: 5 },
            { id: 2, type: 'fill', text: 'Dọc ngang biết mấy nẻo đường\nThắm ……ang sử Việt, rạng ……ương anh hùng\nBao nhiêu ……iến thắng lẫy lừng\nLàm nên Tổ quốc kiêu hùng hôm nay.\n(Nguyễn Lâm Thắng)', instruction: 'Điền “ch” hoặc “tr” vào chỗ trống', answers: ['tr', 'ch', 'ch'], placeholders: 3 },
            { id: 3, type: 'fill', text: 'Chị nhảy vào ổ lá\nNằm ……uống rồi đứng lên\nChân ……oay tròn ……ột ……oạt\nMột hồi mới nằm yên', instruction: 'Điền “x” hoặc “s” vào chỗ trống', answers: ['x', 'x', 's', 's'], placeholders: 4 },
            { id: 4, type: 'fill', text: 'Yêu hàng ớt đã …..a hoa\nĐám …..ưa trổ nụ, đám cà trổ bông.\nYêu sao tiếng mẹ …..u nồng,\nTiếng thoi lách cách bên nong …..âu tằm.\n(Lê Anh Xuân)', instruction: 'Điền “r/d” hoặc “gi” vào chỗ trống', answers: ['r', 'd', 'r', 'd'], placeholders: 4 },
            { id: 5, type: 'fill', text: 'Mẹ ơi tóc bạc tuổi già,\nCấy đêm mẹ vẫn …..ông pha chẳng …..ờn.\nNgón tay bật máu mảnh bom,\nCấy bao nhiêu mạ, căm hờn bấy nhiêu.\n(Lê Anh Xuân)', instruction: 'Điền “x” hoặc “s” vào chỗ trống', answers: ['x', 's'], placeholders: 2 },
            { id: 6, type: 'fill', text: 'Bốn mặt quê hương …..ải phóng …..ồi\nTôi bỗng thấy nội tôi trẻ lại\nNhư thời con gái tuổi đôi mươi\nNhư hàng …..ừa trước ngõ nhà tôi.\n(Lê Anh Xuân)', instruction: 'Điền “r/d” hoặc “gi” vào chỗ trống', answers: ['gi', 'r', 'd'], placeholders: 3 },
            { id: 7, type: 'fill', text: 'Bờ tre cõng tiếng sáo …..iều\nKhúc …..ân ca lại dặt dìu lời …..u\nBốn mùa là đóng câu thơ\nNgọt ngào nồng ấm …..ữa bờ ca …..ao.\n(Theo Nguyễn Lâm Thắng)', instruction: 'Điền “r/d” hoặc “gi” vào chỗ trống', answers: ['d', 'd', 'r', 'gi', 'd'], placeholders: 5 },
            { id: 8, type: 'fill', text: 'Nòi …..e đâu …..ịu mọc cong\nChưa lên đã nhọn như …..ông lạ thường\nLưng …..ần phơi nắng phơi sương\nCó manh áo cộc, …..e nhường cho con.\n(Theo Nguyễn Duy)', instruction: 'Điền “ch” hoặc “tr” vào chỗ trống', answers: ['tr', 'ch', 'ch', 'tr', 'tr'], placeholders: 5 },
            { id: 9, type: 'fill', text: 'Việt Nam đẹp khắp trăm miền\nBốn mùa một sắc trời ……iêng đất này\nXóm làng, đồng …..uộng, …..ừng cây\nNon cao …..ó …..ựng, sông đầy nắng chang.\n(Theo Lê Anh Xuân)', instruction: 'Điền “r/d” hoặc “gi” vào chỗ trống', answers: ['r', 'r', 'r', 'gi', 'd'], placeholders: 5 },
            { id: 10, type: 'fill', text: 'Đầu ……ời ngất đỉnh Hà Giang,\nCà Mau mũi đất mỡ màng phù sa\nTrường Sơn: …..í lớn ông …..a\nCửu Long: lòng mẹ bao la sóng …..ào.\n(Theo Lê Anh Xuân)', instruction: 'Điền “ch” hoặc “tr” vào chỗ trống', answers: ['tr', 'ch', 'ch', 'tr'], placeholders: 4 },
            { id: 11, type: 'correction', text: 'Đêm mưa, ngày nắng xá gì,\nQuân thù còn đó, ta đi chưa về.', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'xá', correct: 'sá' },
            { id: 12, type: 'correction', text: 'Rừng thu trăng dọi hòa bình\nNhớ ai tiếng hát ân tình thủy chung.\n(Theo Tố Hữu)', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'dọi', correct: 'rọi' },
            { id: 13, type: 'correction', text: 'Em yêu nhà em\nHàng xoan trước ngõ\nHoa xao xuyến nở\nNhư mây từng trùm.\n(Theo Tô Hà)', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'trùm', correct: 'chùm' },
            { id: 14, type: 'correction', text: 'Trong trắng mà chang nghiêm\nHương ngát dài ngày đêm\nNhớ hoa giàu ân huệ\nGọi xuân về nắng lên.', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'chang', correct: 'trang' },
            { id: 15, type: 'correction', text: 'Bàn tay lao động\nTa reo sự sống\nTrên từng đất khô;\nBàn tay cần cù\nMặc dù nắng cháy\nKhoai trồng thắm rẫy\nLúa cấy xanh rừng.\n(Theo Hoàng Trung Thông)', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'reo', correct: 'gieo' },
            { id: 16, type: 'correction', text: 'Đất quê hương nát bầm vết đạn\nĐã nuôi dừa năm tháng xanh tươi\nÔi có phải dừa hút bao cay đắng\nĐể chổ ra những trái ngọt cho đời.\n(Theo Lê Anh Xuân)', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'chổ', correct: 'trổ' },
            { id: 17, type: 'correction', text: 'Vươn mình trong gió che đu\nCây kham khổ vẫn hát ru lá cành.\n(Nguyễn Duy)', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'che', correct: 'tre' },
            { id: 18, type: 'correction', text: 'Anh em cùng mẹ khác cha\nCũng như cây cọ xinh ra nhiều cành.', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'xinh', correct: 'sinh' },
            { id: 19, type: 'correction', text: 'Rễ dừa bám sâu vào lòng đất\nNhư dân làng bám trặt quê hương.', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'trặt', correct: 'chặt' },
            { id: 20, type: 'correction', text: 'Đây con sông xuôi dòng nước chảy\nBốn mùa xoi từng mảng mây trời.\n(Hoài Vũ)', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'xoi', correct: 'soi' },
            { id: 21, type: 'correction', text: 'Tìm nơi quần đảo khơi sa\nCó loài hoa nở như là không tên.\n(Nguyễn Đức Mậu)', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'sa', correct: 'xa' },
            { id: 22, type: 'correction', text: 'Câu hát căng buồm với gió khơi\nĐoàn thuyền trạy đua cùng mặt trời.', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'trạy', correct: 'chạy' },
            { id: 23, type: 'correction', text: 'Người ngắm trăng soi ngoài cửa xổ\nTrăng nhòm khe cửa ngắm nhà thơ.', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'xổ', correct: 'sổ' },
            { id: 24, type: 'correction', text: 'Từ lòng khe hẹp thung xa\nSuối giang tay hát khúc ca hợp đồng.', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'giang', correct: 'dang' },
            { id: 25, type: 'correction', text: 'Núi kia ôm chọn biển xanh\nTa như hạt cát mỏng manh giữa đời.', instruction: 'Tìm từ viết sai chính tả và sửa lại', wrong: 'chọn', correct: 'trọn' }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [studentInfo, setStudentInfo] = useState({ name: '', id: '' });
            const [gameState, setGameState] = useState('loading'); 
            const [quizQuestions, setQuizQuestions] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});
            const [isSubmitted, setIsSubmitted] = useState(false);
            const [timeLeft, setTimeLeft] = useState(600);
            const [showReview, setShowReview] = useState(false);
            const [score, setScore] = useState(0);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'spelling-quiz-v4';

            useEffect(() => {
                const timer = setTimeout(() => {
                    if (!window.FirebaseSDK) return;
                    const { initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, getFirestore } = window.FirebaseSDK;
                    
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    authRef.current = getAuth(app);
                    dbRef.current = getFirestore(app);

                    const initAuth = async () => {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(authRef.current, __initial_auth_token);
                        } else {
                            await signInAnonymously(authRef.current);
                        }
                    };
                    initAuth();

                    onAuthStateChanged(authRef.current, (u) => {
                        setUser(u);
                        setGameState('login');
                    });
                }, 1000);
                return () => clearTimeout(timer);
            }, []);

            // Lấy lịch sử theo mã định danh (studentId)
            useEffect(() => {
                if (!user || !dbRef.current || gameState === 'login' || !studentInfo.id) {
                    setHistory([]);
                    return;
                }
                const { collection, onSnapshot } = window.FirebaseSDK;
                const q = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'exam_results');
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(item => item.studentId === studentInfo.id);
                    
                    setHistory(data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
                }, (err) => console.error("Firebase Error:", err));

                return () => unsubscribe();
            }, [user, gameState, studentInfo.id]);

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');
                const inputCode = studentInfo.id.trim().toUpperCase();
                
                const foundName = STUDENT_DATABASE[inputCode];
                if (!foundName) {
                    setError('Mã định danh không chính xác! Vui lòng kiểm tra lại.');
                    return;
                }

                setLoading(true);
                // Giả lập xử lý đăng nhập
                setTimeout(() => {
                    setStudentInfo({ name: foundName, id: inputCode });
                    setGameState('welcome');
                    setLoading(false);
                }, 600);
            };

            const handleLogout = () => {
                setGameState('login');
                setStudentInfo({ name: '', id: '' });
                setUserAnswers({});
                setIsSubmitted(false);
                setError('');
            };

            const initQuiz = useCallback(() => {
                const shuffled = [...ALL_QUESTIONS].sort(() => 0.5 - Math.random());
                setQuizQuestions(shuffled.slice(0, 10));
                setUserAnswers({});
                setIsSubmitted(false);
                setTimeLeft(600);
                setCurrentIdx(0);
                setShowReview(false);
                setGameState('quiz');
            }, []);

            useEffect(() => {
                if (gameState === 'quiz' && timeLeft > 0 && !isSubmitted) {
                    const timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
                    return () => clearInterval(timer);
                } else if (timeLeft === 0 && !isSubmitted && gameState === 'quiz') {
                    handleSubmit();
                }
            }, [timeLeft, isSubmitted, gameState]);

            const handleSubmit = async () => {
                if (isSubmitted) return;
                let totalScore = 0;
                quizQuestions.forEach(q => { if (checkAnswer(q)) totalScore += 10; });
                setScore(totalScore);
                setIsSubmitted(true);
                
                try {
                    const { addDoc, collection } = window.FirebaseSDK;
                    const timeTaken = 600 - timeLeft;
                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'exam_results'), {
                        timestamp: new Date().toISOString(),
                        score: totalScore,
                        timeLabel: `${Math.floor(timeTaken / 60)}p ${timeTaken % 60}s`,
                        studentName: studentInfo.name,
                        studentId: studentInfo.id 
                    });
                } catch (err) {
                    console.error("Save Error:", err);
                }
            };

            const checkAnswer = (q) => {
                const userAns = userAnswers[q.id] || {};
                if (q.type === 'fill') {
                    return q.answers.every((ans, idx) => (userAns[idx] || '').trim().toLowerCase() === ans.toLowerCase());
                } else {
                    return (userAns[0] || '').trim().toLowerCase() === q.wrong.toLowerCase() && 
                           (userAns[1] || '').trim().toLowerCase() === q.correct.toLowerCase();
                }
            };

            const isQuestionAnswered = (qId) => {
                const ans = userAnswers[qId];
                if (!ans) return false;
                const q = quizQuestions.find(item => item.id === qId);
                if (!q) return false;
                const vals = Object.values(ans);
                const reqCount = q.type === 'fill' ? q.placeholders : 2;
                return vals.length === reqCount && vals.every(v => v.trim() !== '');
            };

            if (gameState === 'loading') {
                return <div className="min-h-screen flex items-center justify-center font-black text-slate-300 uppercase tracking-widest animate-pulse">Khởi động hệ thống...</div>;
            }

            // MÀN HÌNH ĐĂNG NHẬP (CHỈ NHẬP MÃ)
            if (gameState === 'login') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                        <div className="bg-white rounded-[3rem] shadow-2xl p-8 md:p-14 max-w-md w-full border border-slate-100 animate-in zoom-in duration-500 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-3 bg-blue-600"></div>
                            <div className="text-center mb-12">
                                <div className="w-20 h-20 bg-blue-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-100 animate-float">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>
                                </div>
                                <h1 className="text-3xl font-black text-slate-800 tracking-tight mb-2 uppercase">Hệ Thống Thi</h1>
                                <p className="text-slate-400 font-bold text-[10px] uppercase tracking-[0.3em]">Nhập mã định danh để tiếp tục</p>
                            </div>
                            
                            <form onSubmit={handleLogin} className="space-y-6">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">Mã Định Danh Của Em</label>
                                    <div className="relative">
                                        <input 
                                            required 
                                            type="text" 
                                            value={studentInfo.id} 
                                            onChange={e => setStudentInfo({...studentInfo, id: e.target.value})} 
                                            className={`w-full px-8 py-5 bg-slate-50 border-2 rounded-2xl focus:border-blue-500 focus:bg-white outline-none transition-all font-black text-2xl text-blue-600 placeholder:text-slate-200 uppercase text-center tracking-widest ${error ? 'border-red-500 shake' : 'border-slate-50'}`} 
                                            placeholder="VD: VC-9921" 
                                        />
                                        <div className="absolute inset-y-0 left-6 flex items-center pointer-events-none opacity-20">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                                        </div>
                                    </div>
                                    {error && <p className="text-red-500 text-[10px] font-black text-center mt-4 uppercase tracking-wider">{error}</p>}
                                </div>

                                <button 
                                    type="submit" 
                                    disabled={loading || !user} 
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl transition-all shadow-xl shadow-blue-100 flex justify-center items-center gap-3 mt-6 active:scale-95 group"
                                >
                                    {loading ? "Đang Tra Cứu..." : "Xác Nhận Đăng Nhập"}
                                    {!loading && <svg className="group-hover:translate-x-1 transition-transform" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>}
                                </button>
                            </form>
                            
                            <div className="mt-12 pt-8 border-t border-slate-50 text-center">
                                <p className="text-[9px] text-slate-300 font-black uppercase tracking-[0.2em]">Dành cho kỳ thi Tiếng Việt Cấp Tỉnh</p>
                            </div>
                        </div>
                    </div>
                );
            }

            // MÀN HÌNH CHÀO MỪNG (WELCOME)
            if (gameState === 'welcome') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-50">
                        <div className="bg-white rounded-[4rem] shadow-2xl p-10 md:p-16 max-w-lg w-full text-center border border-white animate-in slide-in-from-bottom-10 duration-700">
                            <div className="mb-8">
                                <span className="px-6 py-2 bg-blue-50 text-blue-600 rounded-full text-[10px] font-black uppercase tracking-[0.3em] border border-blue-100">Xác thực thành công</span>
                            </div>
                            <h2 className="text-slate-400 font-bold uppercase text-[10px] tracking-[0.5em] mb-4">Chào mừng học sinh</h2>
                            <h1 className="text-5xl font-black text-slate-800 mb-2 leading-tight tracking-tighter">{studentInfo.name}</h1>
                            <div className="inline-flex items-center gap-2 mb-12">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                <p className="text-slate-400 font-black text-sm tracking-[0.2em]">{studentInfo.id}</p>
                            </div>
                            
                            <div className="grid grid-cols-1 gap-5">
                                <button onClick={initQuiz} className="bg-blue-600 hover:bg-blue-700 text-white font-black py-6 rounded-3xl transition-all shadow-2xl shadow-blue-100 transform hover:-translate-y-1 active:scale-95 text-xl tracking-[0.2em] uppercase">
                                    Bắt Đầu Thi
                                </button>
                                <button onClick={handleLogout} className="bg-slate-50 hover:bg-slate-100 text-slate-400 font-black py-5 rounded-3xl transition-all flex items-center justify-center gap-2 uppercase text-[10px] tracking-widest border border-slate-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                    Đổi Mã Định Danh
                                </button>
                            </div>
                        </div>

                        {history.length > 0 && (
                            <div className="mt-16 max-w-lg w-full animate-in fade-in duration-1000">
                                <h3 className="text-center text-[10px] font-black text-slate-300 uppercase tracking-[0.4em] mb-8">Lịch sử bài thi của em</h3>
                                <div className="space-y-4">
                                    {history.slice(0, 3).map(h => (
                                        <div key={h.id} className="bg-white/80 backdrop-blur-md p-6 rounded-[2rem] flex justify-between items-center border border-white shadow-sm hover:shadow-lg transition-all transform hover:-translate-x-1">
                                            <div className="flex flex-col gap-1">
                                                <span className="text-[10px] font-black text-slate-300 uppercase">{new Date(h.timestamp).toLocaleDateString('vi-VN')}</span>
                                                <span className="text-slate-500 font-bold text-xs italic opacity-60">{h.timeLabel}</span>
                                            </div>
                                            <div className="text-4xl font-black text-blue-600 tracking-tighter">{h.score}<span className="text-[10px] text-slate-300 ml-1 font-bold uppercase">đ</span></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            const currentQuestion = quizQuestions[currentIdx];

            return (
                <div className="min-h-screen p-4 md:p-8 bg-slate-50">
                    <div className="max-w-6xl mx-auto">
                        <header className="flex flex-col md:flex-row justify-between items-center mb-10 bg-white/90 backdrop-blur-xl p-6 rounded-[2.5rem] shadow-sm border border-white sticky top-4 z-50">
                            <div className="flex items-center gap-5">
                                <div className="w-14 h-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-2xl shadow-blue-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>
                                </div>
                                <div>
                                    <h1 className="text-xl font-black text-slate-800 tracking-tight leading-tight uppercase">Phòng Thi Tiếng Việt</h1>
                                    <p className="text-blue-600 text-[10px] font-black uppercase tracking-[0.2em] mt-0.5">{studentInfo.name} • {studentInfo.id}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-6 mt-4 md:mt-0">
                                <div className={`px-8 py-3 rounded-2xl font-mono text-3xl font-black border-2 transition-all shadow-inner ${timeLeft < 60 ? 'border-red-500 text-red-600 animate-pulse bg-red-50' : 'border-blue-50 text-blue-600 bg-blue-50/20'}`}>
                                    {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
                                </div>
                                {!isSubmitted && (
                                    <button onClick={handleSubmit} className="bg-blue-600 hover:bg-blue-700 text-white px-12 py-3.5 rounded-2xl font-black shadow-2xl shadow-blue-100 active:scale-95 transition-all text-sm uppercase tracking-widest">Nộp Bài</button>
                                )}
                            </div>
                        </header>

                        {isSubmitted && !showReview ? (
                            <div className="bg-white rounded-[4rem] p-16 text-center shadow-2xl border border-white max-w-2xl mx-auto mb-20 animate-in zoom-in duration-500 relative">
                                <div className="absolute top-0 left-0 w-full h-4 bg-blue-600"></div>
                                <h3 className="text-[11px] font-black text-blue-400 uppercase tracking-[0.6em] mb-6">Kết quả của em</h3>
                                <div className="text-[14rem] font-black text-blue-600 leading-none drop-shadow-[0_20px_20px_rgba(37,99,235,0.2)] mb-8">{score}</div>
                                <div className="text-2xl font-black text-slate-300 mb-16 uppercase tracking-widest italic leading-relaxed">"Bài thi của {studentInfo.name} đã được ghi lại!"</div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-5 max-w-md mx-auto">
                                    <button onClick={() => setShowReview(true)} className="border-2 border-slate-100 hover:border-blue-500 hover:text-blue-600 font-black py-5 px-8 rounded-3xl transition-all uppercase text-xs tracking-widest">Xem đáp án</button>
                                    <button onClick={initQuiz} className="bg-blue-600 hover:bg-blue-700 text-white font-black py-5 px-8 rounded-3xl transition-all shadow-2xl shadow-blue-100 active:scale-95 uppercase text-xs tracking-widest">Thi lại bài mới</button>
                                </div>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-12 mb-20">
                                <div className="lg:col-span-3">
                                    <div className="bg-white rounded-[3rem] shadow-sm border border-slate-100 overflow-hidden">
                                        <div className="bg-slate-50/50 px-12 py-7 border-b border-slate-100 flex justify-between items-center">
                                            <span className="font-black text-slate-300 uppercase text-[10px] tracking-[0.5em]">Câu hỏi {currentIdx + 1} / 10</span>
                                            <div className="flex gap-2.5">
                                                {[...Array(10)].map((_, i) => (
                                                    <div key={i} className={`w-4 h-2 rounded-full transition-all duration-500 ${i === currentIdx ? 'bg-blue-600 w-12' : 'bg-slate-200'}`}></div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="p-14">
                                            <h3 className="text-xl text-blue-600/60 mb-10 font-black italic tracking-tight border-b-2 border-blue-50 pb-4 uppercase text-[12px] tracking-widest">{currentQuestion.instruction}</h3>
                                            <div className="bg-slate-50 p-14 rounded-[3.5rem] mb-16 leading-[2] text-3xl whitespace-pre-line border-l-[15px] border-blue-600 shadow-inner font-medium text-slate-800 animate-in fade-in slide-in-from-left-6">{currentQuestion.text}</div>
                                            
                                            <div className="space-y-12 px-4">
                                                {currentQuestion.type === 'fill' ? (
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                                                        {currentQuestion.answers.map((_, idx) => (
                                                            <div key={idx} className="group">
                                                                <span className="text-slate-300 text-[11px] font-black uppercase ml-1 tracking-[0.4em] group-focus-within:text-blue-500 transition-colors">Vị trí {idx + 1}</span>
                                                                <input type="text" disabled={isSubmitted} value={userAnswers[currentQuestion.id]?.[idx] || ''} onChange={(e) => {
                                                                    const val = e.target.value;
                                                                    setUserAnswers(prev => ({ ...prev, [currentQuestion.id]: { ...prev[currentQuestion.id], [idx]: val } }));
                                                                }} className={`w-full border-2 rounded-2xl p-7 outline-none transition-all font-black text-3xl text-blue-700 shadow-sm ${isSubmitted ? ((userAnswers[currentQuestion.id]?.[idx] || '').trim().toLowerCase() === currentQuestion.answers[idx].toLowerCase() ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500') : 'bg-white border-slate-50 focus:border-blue-400 focus:scale-[1.03]'}`} placeholder="..." />
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                                                        <div>
                                                            <label className="text-[11px] font-black text-slate-300 uppercase ml-1 mb-4 block tracking-[0.4em]">Từ viết sai trong thơ</label>
                                                            <input type="text" disabled={isSubmitted} value={userAnswers[currentQuestion.id]?.[0] || ''} onChange={(e) => {
                                                                const val = e.target.value;
                                                                setUserAnswers(prev => ({ ...prev, [currentQuestion.id]: { ...prev[currentQuestion.id], [0]: val } }));
                                                            }} className={`w-full border-2 rounded-2xl p-7 font-black text-3xl shadow-sm ${isSubmitted ? ((userAnswers[currentQuestion.id]?.[0] || '').trim().toLowerCase() === currentQuestion.wrong.toLowerCase() ? 'bg-green-50 border-green-500 text-green-700' : 'bg-red-50 border-red-500 text-red-700') : 'bg-white border-slate-50 focus:border-blue-400'}`} />
                                                        </div>
                                                        <div>
                                                            <label className="text-[11px] font-black text-slate-300 uppercase ml-1 mb-4 block tracking-[0.4em]">Sửa lại cho đúng</label>
                                                            <input type="text" disabled={isSubmitted} value={userAnswers[currentQuestion.id]?.[1] || ''} onChange={(e) => {
                                                                const val = e.target.value;
                                                                setUserAnswers(prev => ({ ...prev, [currentQuestion.id]: { ...prev[currentQuestion.id], [1]: val } }));
                                                            }} className={`w-full border-2 rounded-2xl p-7 font-black text-3xl shadow-sm ${isSubmitted ? ((userAnswers[currentQuestion.id]?.[1] || '').trim().toLowerCase() === currentQuestion.correct.toLowerCase() ? 'bg-green-50 border-green-500 text-green-700' : 'bg-red-50 border-red-500 text-red-700') : 'bg-white border-slate-50 focus:border-blue-400'}`} />
                                                        </div>
                                                    </div>
                                                )}
                                                {isSubmitted && (
                                                    <div className="mt-14 p-12 bg-slate-900 rounded-[3.5rem] text-white shadow-[0_30px_60px_-15px_rgba(0,0,0,0.3)] animate-in fade-in slide-in-from-bottom-8">
                                                        <p className="font-black uppercase text-[11px] tracking-[0.6em] mb-5 text-blue-500">Đáp án từ tài liệu gốc:</p>
                                                        <p className="text-4xl font-black italic">{currentQuestion.type === 'fill' ? currentQuestion.answers.join(' , ') : `${currentQuestion.wrong} → ${currentQuestion.correct}`}</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <div className="bg-slate-50/50 p-12 flex justify-between border-t border-slate-100">
                                            <button disabled={currentIdx === 0} onClick={() => setCurrentIdx(prev => prev - 1)} className="font-black text-xs uppercase tracking-[0.4em] text-slate-400 hover:text-blue-600 disabled:opacity-20 px-12 py-6 transition-all">Quay lại</button>
                                            <button disabled={currentIdx === quizQuestions.length - 1} onClick={() => setCurrentIdx(prev => prev + 1)} className="bg-white border-2 border-slate-100 px-16 py-6 rounded-2xl font-black text-xs uppercase tracking-[0.4em] shadow-sm hover:border-blue-400 active:scale-95 transition-all">Tiếp tục</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="lg:col-span-1">
                                    <div className="bg-white rounded-[3rem] shadow-sm border border-slate-100 p-10 sticky top-32">
                                        <h3 className="font-black text-slate-800 mb-10 text-[11px] uppercase tracking-[0.5em] border-b-2 border-slate-50 pb-6 text-center">Bảng Câu Hỏi</h3>
                                        <div className="grid grid-cols-5 gap-4 mb-12">
                                            {quizQuestions.map((q, idx) => {
                                                const answered = isQuestionAnswered(q.id);
                                                const correct = isSubmitted && checkAnswer(q);
                                                let cls = "w-12 h-12 flex items-center justify-center rounded-2xl border-2 font-black text-sm transition-all ";
                                                if (isSubmitted) cls += correct ? "bg-green-500 border-green-500 text-white shadow-lg" : "bg-red-500 border-red-500 text-white shadow-lg";
                                                else if (answered) cls += "bg-blue-600 border-blue-600 text-white shadow-2xl scale-110";
                                                else cls += "bg-white border-slate-50 text-slate-300";
                                                if (currentIdx === idx) cls += " ring-8 ring-blue-50 border-blue-600 text-blue-600 shadow-xl shadow-blue-50";
                                                return <button key={idx} onClick={() => setCurrentIdx(idx)} className={cls}>{idx + 1}</button>;
                                            })}
                                        </div>
                                        
                                        <div className="space-y-6 pt-10 border-t border-slate-50">
                                            <div className="flex items-center justify-between">
                                                <span className="text-[11px] font-black uppercase text-slate-400 tracking-[0.2em]">Đã làm</span>
                                                <span className="font-black text-blue-600 text-sm">{quizQuestions.filter(q => isQuestionAnswered(q.id)).length} / 10</span>
                                            </div>
                                            <div className="w-full bg-slate-50 h-3 rounded-full overflow-hidden">
                                                <div className="bg-blue-500 h-full transition-all duration-1000 ease-out shadow-lg" style={{width: `${(quizQuestions.filter(q => isQuestionAnswered(q.id)).length / 10) * 100}%`}}></div>
                                            </div>
                                        </div>
                                        
                                        {isSubmitted && (
                                            <button onClick={() => setGameState('welcome')} className="w-full mt-14 py-6 bg-slate-50 text-slate-400 rounded-[2rem] font-black text-[10px] uppercase tracking-[0.4em] hover:bg-slate-100 transition-all border border-slate-100">Về Hồ Sơ Của Em</button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* LỊCH SỬ KẾT QUẢ RIÊNG CHO TỪNG MÃ ĐỊNH DANH */}
                        {history.length > 0 && gameState !== 'login' && (
                            <div className="mt-24 bg-white rounded-[5rem] shadow-[0_50px_100px_-20px_rgba(0,0,0,0.1)] border border-white overflow-hidden animate-in fade-in duration-1000 delay-300 border-t-[12px] border-t-blue-600">
                                <div className="px-16 py-14 bg-slate-50/50 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-10">
                                    <div>
                                        <h3 className="font-black text-5xl text-slate-800 tracking-tighter leading-none mb-4 uppercase italic">Sổ Tay Kết Quả</h3>
                                        <p className="text-slate-400 text-[11px] font-black uppercase tracking-[0.5em] flex items-center gap-3">Học sinh: <span className="text-blue-600 border-b-2 border-blue-100">{studentInfo.name}</span> <span className="opacity-20">|</span> Mã: <span className="text-blue-600">{studentInfo.id}</span></p>
                                    </div>
                                    <div className="flex items-center gap-5">
                                        <span className="text-[11px] font-black text-blue-600 bg-white border border-blue-50 px-8 py-4 rounded-[2rem] uppercase tracking-[0.4em] shadow-sm">{history.length} Lần Thi</span>
                                    </div>
                                </div>
                                <div className="overflow-x-auto hide-scrollbar p-8">
                                    <table className="w-full text-left">
                                        <thead className="text-[11px] uppercase text-slate-300 font-black border-b-2 border-slate-50">
                                            <tr>
                                                <th className="px-10 py-8">Thứ tự</th>
                                                <th className="px-10 py-8">Thời điểm làm bài</th>
                                                <th className="px-10 py-8">Tốc độ làm</th>
                                                <th className="px-10 py-8 text-right">Điểm đạt được</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {history.map((h, i) => (
                                                <tr key={h.id} className="hover:bg-blue-50/40 transition-all group cursor-default">
                                                    <td className="px-10 py-10 font-black text-slate-200 group-hover:text-blue-500 transition-colors text-2xl">#{history.length - i}</td>
                                                    <td className="px-10 py-10 text-slate-600 font-black text-sm">{new Date(h.timestamp).toLocaleString('vi-VN')}</td>
                                                    <td className="px-10 py-10 text-slate-400 font-bold italic text-xs uppercase tracking-widest">{h.timeLabel}</td>
                                                    <td className="px-10 py-10 text-right">
                                                        <span className={`px-10 py-4 rounded-3xl font-black text-4xl shadow-sm ${h.score >= 80 ? 'text-green-600 bg-green-50 border border-green-100' : 'text-blue-600 bg-blue-50 border border-blue-100'}`}>
                                                            {h.score}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>